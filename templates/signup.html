{% extends "base.html" %}

{% block title %}Sign Up{% endblock %}

{% block content %}
<div class="container mt-5 px-3" style="max-width: 500px;">
  <h2 class="mb-4 text-center" style="font-size: 1.8rem;">Create Your Dog-Free Account</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

    <div class="container mt-5" style="max-width: 500px;">

        <form method="POST">

            <div class="mb-3">
                <label for="username" class="form-label">Username:</label>
                <input type="text" id="username" name="username" class="form-control"
                    value="{{ username or '' }}" required>
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" id="email" name="email" class="form-control" required>
            </div>


            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" name="password"
                       required pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W_]).{8,}"
                       title="Must be at least 8 characters, include uppercase, lowercase, a number, and a special character.">
            </div>



            <div class="mb-3">
                <label for="display_name" class="form-label">Display Name</label>
                <input type="text" id="display_name" name="display_name" class="form-control">
            </div>

            <div class="mb-3">
                <label for="birthday">Birthday</label>
                <input type="date" id="birthday" name="birthday" required>

            </div>

                        <!-- Gender Dropdown -->
            <div class="mb-3">
              <label class="form-label">Gender</label>
              <select name="gender" class="form-select">
                <option value="">Prefer not to say</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Nonbinary">Nonbinary</option>
                <option value="Trans Man">Trans Man</option>
                <option value="Trans Woman">Trans Woman</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Show Gender Toggle -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="show_gender" id="showGender">
              <label class="form-check-label" for="showGender">
                Show my gender on my public profile
              </label>
            </div>

            <!-- Sexuality Dropdown -->
            <div class="mb-3">
              <label class="form-label">Sexual Orientation</label>
              <select name="sexuality" class="form-select">
                <option value="">Prefer not to say</option>
                <option value="Straight">Straight</option>
                <option value="Gay">Gay</option>
                <option value="Lesbian">Lesbian</option>
                <option value="Bisexual">Bisexual</option>
                <option value="Pansexual">Pansexual</option>
                <option value="Asexual">Asexual</option>
                <option value="Queer">Queer</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <!-- Show Sexuality Toggle -->
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="show_sexuality" id="showSexuality">
              <label class="form-check-label" for="showSexuality">
                Show my orientation on my public profile
              </label>
            </div>


                        <!-- ğŸ”– Main Tag Dropdown -->
            <div class="mb-3">
              <label class="form-label"><strong>Main Tag</strong></label>
              <select class="form-select" name="main_tag" required>
                <option value="">Choose your main tag</option>

                <optgroup label="ğŸ¾ Fun & Identity Tags">
                  <option value="Reptile Roomie">ğŸ Reptile Roomie</option>
                    <option value="Cat Companion">ğŸ± Cat Companion</option>
                    <option value="Rodent Roomie">ğŸ Rodent Roomie</option>
                    <option value="Bird Bestie">ğŸ¦œ Bird Bestie</option>
                    <option value="Fish Friend">ğŸŸ Fish Friend</option>
                    <option value="Turtle Tenant">ğŸ¢ Turtle Tenant</option>
                    <option value="Plant Person">ğŸª´ Plant Person</option>
                    <option value="Bug Buddy">ğŸª³ Bug Buddy</option>
                    <option value="My Petâ€™s a Vibe">ğŸ‘½ My Petâ€™s a Vibe</option>
                    <option value="No Bark Zone">ğŸš« No Bark Zone</option>
                    <option value="Clean House > Cute Paws">ğŸ§¼ Clean House > Cute Paws</option>
                    <option value="Fully Pet-Free">ğŸš« Fully Pet-Free</option>
                    <option value="Allergic to Everything">ğŸ¤§ Allergic to Everything</option>
                    <option value="Hates Loud Noises">ğŸ§» Hates Loud Noises</option>
                    <option value="Hates Loud Noises">ğŸ§» Hates Loud Noises</option>
                    <option value="Bed is Sacred">ğŸ˜´ Bed is Sacred</option>
                    <option value="No Dog Hair, No Cry">ğŸ¶ No Dog Hair, No Cry</option>
                    <option value="Not Here for Doggy Breath">ğŸš· Not Here for Doggy Breath</option>
                    <option value="My Couch > Your Dog">ğŸ›‹ï¸ My Couch > Your Dog</option>
                    <option value="Cat Yes, Dog No">ğŸ± Cat Yes, Dog No</option>
                    <option value="Slo-Mo Pets Only">ğŸ¢ Slo-Mo Pets Only</option>
                    <option value="Don't Judge My Pet Cockroach">Donâ€™t Judge My Pet Cockroach</option>
                    <option value="Lizard Liker">ğŸ¦ Lizard Liker</option>
                </optgroup>

                <optgroup label="ğŸŒ± Lifestyle & Values Tags">
                    <option value="Child-Free">Child-Free</option>
                    <option value="Single Parent">Single Parent</option>
                    <option value="Divorced">Divorced</option>
                    <option value="Parent (Don't live with kids)">Parent (Don't live with kids)</option>
                    <option value="Parent (Kids part-time)">Parent (Kids part-time)</option>
                    <option value="Open to Kids">Open to Kids</option>
                    <option value="Neurodivergent">Neurodivergent</option>
                    <option value="Creative at Heart">Creative at Heart</option>
                    <option value="Digital Nomad">Digital Nomad</option>
                    <option value="Career-Focused">Career-Focused</option>
                    <option value="Just Looking for Friends">Just Looking for Friends</option>
                    <option value="Monogamous">Monogamous</option>
                    <option value="Open to ENM">Open to ENM</option>
                </optgroup>
              </select>
            </div>


                        <!-- â• Additional Tags -->
            <div class="mb-3">
              <label class="form-label"><strong>Additional Tags</strong> (optional)</label>
              <div class="d-flex flex-wrap gap-2">

                {% set additional_tags = [
                  "Reptile Roomie", "Cat Companion", "Rodent Roomie", "Bird Bestie",
                  "Fish Friend", "Turtle Tenant", "Plant Person", "Bug Buddy",
                  "My Petâ€™s a Vibe", "No Bark Zone", "Hates Loud Noises", "Bed is Sacred",
                  "No Dog Hair, No Cry", "Not Here for Doggy Breath", "My Couch > Your Dog", "Cat Yes, Dog No",
                  "Slo-Mo Pets Only", "Donâ€™t Judge My Pet Cockroach", "Lizard Liker", "Clean House > Cute Paws",
                  "Fully Pet-Free", "Allergic to Everything", "Child-Free", "Divorced", "Single Parent", "Parent (Don't live with kids)",
                  "Parent (Kids part-time)", "Open to Kids", "Neurodivergent", "Creative at Heart",
                  "Digital Nomad", "Career-Focused", "Just Looking for Friends", "Monogamous", "Open to ENM"
                ] %}

                {% for tag in additional_tags %}
                  <input type="checkbox" class="btn-check" name="tags" id="tag-{{ loop.index }}" value="{{ tag }}">
                  <label class="btn btn-outline-light btn-sm" for="tag-{{ loop.index }}">{{ tag }}</label>
                {% endfor %}
              </div>
            </div>



            <div class="mb-3">
                <label for="bio" class="form-label">Short Bio</label>
                <textarea id="bio" name="bio" class="form-control" rows="3" placeholder="Write a little about yourself..."></textarea>
            </div>

            <!-- ğŸŒ Country Select -->
            <div class="mb-3">
              <label for="countrySelect" class="form-label">Country</label>
              <select id="countrySelect" name="country" class="form-select">
                <option value="">Select a country</option>
                {% for code, name in country_list.items() %}
                  <option value="{{ code|lower }}">{{ name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- ğŸ§  Smart City Input -->
            <div class="mb-3">
              <label for="locationInput" class="form-label">City</label>
              <input type="text" class="form-control" name="location" id="locationInput" placeholder="Enter your city...">
              <div id="citySuggestions" class="list-group mt-1"></div>
            </div>


            <!-- ğŸ“ Use My Location -->
            <div class="mb-3">
              <label class="form-label"><strong>Location</strong></label><br>
              <button type="button" class="btn btn-outline-primary btn-sm text-white" onclick="requestUserLocation()">ğŸ“ Use My Location</button>
              <div id="location-status" class="form-text mt-2 text-white-50">Location not set yet.</div>

            </div>

            <!-- ğŸ§­ Hidden Coordinates -->
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">




            <div class="mb-3">
                <label for="favorite_animal" class="form-label">Favorite Animal (besides dogs)</label>
                <input type="text" id="favorite_animal" name="favorite_animal" class="form-control">
            </div>

            <div class="mb-3">
                <label for="dog_free_reason" class="form-label">Why are you dog-free?</label>
                <textarea id="dog_free_reason" name="dog_free_reason" class="form-control" rows="3" placeholder="Ex: Allergic, prefer cats..."></textarea>
            </div>

            <div class="form-check mb-3">
                <input type="checkbox" id="dog_free" name="dog_free" class="form-check-input">
                <label for="dog_free" class="form-check-label">I swear I am dog-free and will remain dog-free.</label>
            </div>

            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" name="agree_terms" id="agreeTerms" required>
              <label class="form-check-label" for="agreeTerms">
                I agree to the <a href="{{ url_for('terms') }}" class="text-white" target="_blank">Terms of Use</a>
              </label>
            </div>



            <button type="submit" class="btn btn-primary w-100">Sign Up</button>
        </form>

            <p class="small text-center mt-3 text-white-50">
              By continuing, you agree to our <a href="{{ url_for('terms') }}" class="text-white">Terms of Use</a>.
            </p>



        <div class="text-center mt-3">
            <a href="/login" class="text-white" >Already have an account? Log in</a>
        </div>
    </div>

<script>
function requestUserLocation() {
    const status = document.getElementById("location-status");
    if (!navigator.geolocation) {
        status.textContent = "Geolocation is not supported by your browser.";
        return;
    }

    status.textContent = "Detecting location...";

    navigator.geolocation.getCurrentPosition(
        position => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);

            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;

            status.textContent = `Location set (Lat: ${lat}, Lon: ${lon})`;
        },
        error => {
            status.textContent = "Unable to retrieve location.";
        }
    );
}
</script>
<script>
const input = document.getElementById("locationInput");
const suggestions = document.getElementById("citySuggestions");
const countrySelect = document.getElementById("countrySelect");

input.addEventListener("input", () => {
  const query = input.value.trim();
  suggestions.innerHTML = "";
  if (query.length < 3) return;

  const country = countrySelect.value;
  let apiUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`;
  if (country) {
    apiUrl += `&countrycodes=${country}`;

  }

  fetch(apiUrl)
    .then(res => res.json())
    .then(data => {
      data.forEach(place => {
        const option = document.createElement("button");
        option.type = "button";
        option.className = "list-group-item list-group-item-action";
        option.textContent = place.display_name;
        option.addEventListener("click", () => {
          input.value = place.display_name;
          document.getElementById("latitude").value = place.lat;
          document.getElementById("longitude").value = place.lon;
          document.getElementById("location-status").textContent = `ğŸŒ Set to: ${place.display_name}`;
          suggestions.innerHTML = "";
        });
        suggestions.appendChild(option);
      });
    });
});

document.addEventListener("click", (e) => {
  if (!suggestions.contains(e.target) && e.target !== input) {
    suggestions.innerHTML = "";
  }
});
</script>



</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Your <script> tags from the original file
// (requestUserLocation and city suggestion scripts)
</script>
{% endblock %}
