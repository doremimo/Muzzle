{% extends "base.html" %}

{% block content %}
<div class="container mt-4 pt-5">

  <!-- ğŸ” Toggle & Filter Form -->
  <button class="btn btn-outline-primary btn-sm mb-3" id="topFilterToggle">ğŸ” Filters</button>

  <form id="topFilterForm" method="POST" class="card p-3 d-none">
    <!-- Age Sliders -->
    <div class="mb-3">
      <label class="form-label">Age Range</label>
      <div class="d-flex align-items-center gap-3">
        <span id="minAgeLabel">18</span>
        <input type="range" class="form-range" id="minAge" name="min_age" min="18" max="99" value="18">
        <input type="range" class="form-range" id="maxAge" name="max_age" min="18" max="99" value="99">
        <span id="maxAgeLabel">99</span>
      </div>
    </div>

    <!-- Location -->
    <div class="mb-3">
      <label class="form-label">Location</label>
      <input type="text" name="location" class="form-control">
    </div>

    <!-- Gender -->
    <div class="mb-3">
      <label class="form-label">Gender</label>
      <select name="gender" class="form-select">
        <option value="">Any</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Nonbinary">Nonbinary</option>
        <option value="Prefer not to say">Prefer not to say</option>
      </select>
    </div>

    <!-- Preferred Tags -->
    <div class="mb-3">
      <label class="form-label">Preferred Tags</label>
      <div id="preferred-tags" class="d-flex flex-wrap gap-2">
        {% for tag in ["Fully Pet-Free", "Reptile Roomie", "Cat Companion", "Rodent Roomie", "Bird Bestie", "Fish Friend", "Turtle Tenant", "Plant Person", "Bug Buddy"] %}
          <button type="button" class="btn btn-outline-primary btn-sm tag-chip" data-tag="{{ tag }}">{{ tag }}</button>
        {% endfor %}
      </div>
      <input type="hidden" name="preferred_tags" id="preferredTagsInput">
    </div>

    <!-- Dealbreaker Tags -->
    <div class="mb-3">
      <label class="form-label">Dealbreaker Tags</label>
      <div id="dealbreaker-tags" class="d-flex flex-wrap gap-2">
        {% for tag in ["Fully Pet-Free", "Reptile Roomie", "Cat Companion", "Rodent Roomie", "Bird Bestie", "Fish Friend", "Turtle Tenant", "Plant Person", "Bug Buddy"] %}
          <button type="button" class="btn btn-outline-danger btn-sm tag-chip" data-tag="{{ tag }}">{{ tag }}</button>
        {% endfor %}
      </div>
      <input type="hidden" name="dealbreaker_tags" id="dealbreakerTagsInput">
    </div>

    <!-- Submit -->
    <div class="text-end">
      <button type="submit" class="btn btn-primary">Apply Filters</button>
    </div>
  </form>

  <!-- ğŸ§¡ Browse Results -->
  {% if users %}
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for user, score in users %}
        <div class="col">
          <div class="card h-100 shadow-sm">
            <img src="{{ url_for('static', filename=user[6] or 'profilepics/default_profile_pic.png') }}"
                 class="card-img-top" style="height: 250px; object-fit: cover;" alt="Profile Picture">
            <div class="card-body">
              <h5 class="card-title mb-1">{{ user[0] }}, {{ user[2] or '?' }}</h5>
              <p class="card-text text-muted mb-2">{{ user[3] or 'No location' }}</p>
              {% if user[10] %}
                <span class="badge bg-primary fs-6">{{ user[10] }}</span>
              {% endif %}
              {% set tag_list = user[11].split(',') if user[11] else [] %}
              <div class="mt-2">
                {% for tag in tag_list[:2] %}
                  <span class="badge bg-secondary me-1">{{ tag }}</span>
                {% endfor %}
              </div>
              {% if score >= 4 %}
                <div class="mt-2">
                  <span class="badge bg-success">ğŸ’˜ High Match</span>
                </div>
              {% endif %}
            </div>
            <form method="POST" action="{{ url_for('like', username=user[1]) }}" class="card-footer text-end">
              <button type="submit" class="btn btn-outline-danger btn-sm">ğŸ’— Like</button>
              <a href="{{ url_for('view_user_profile', username=user[1]) }}" class="btn btn-outline-secondary btn-sm">View</a>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center mt-4">No users match your filters. Try again!</div>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("topFilterToggle");
  const filterForm = document.getElementById("topFilterForm");

  toggleBtn.addEventListener("click", () => {
    filterForm.classList.toggle("d-none");
  });

  // Age slider sync
  const minSlider = document.getElementById("minAge");
  const maxSlider = document.getElementById("maxAge");
  const minLabel = document.getElementById("minAgeLabel");
  const maxLabel = document.getElementById("maxAgeLabel");

  function syncAge() {
    let min = parseInt(minSlider.value);
    let max = parseInt(maxSlider.value);
    if (min > max) [minSlider.value, maxSlider.value] = [max, min];
    minLabel.textContent = minSlider.value;
    maxLabel.textContent = maxSlider.value;
  }

  minSlider.addEventListener("input", syncAge);
  maxSlider.addEventListener("input", syncAge);
  syncAge();

  // Tag chip logic
  function setupChips(containerId, hiddenInputId) {
    const container = document.getElementById(containerId);
    const hidden = document.getElementById(hiddenInputId);
    const selected = new Set();

    container.addEventListener("click", e => {
      if (e.target.classList.contains("tag-chip")) {
        const tag = e.target.dataset.tag;
        e.target.classList.toggle("active");
        if (selected.has(tag)) selected.delete(tag);
        else selected.add(tag);
        hidden.value = [...selected].join(",");
      }
    });
  }

  setupChips("preferred-tags", "preferredTagsInput");
  setupChips("dealbreaker-tags", "dealbreakerTagsInput");
});
</script>
{% endblock %}
